<!DOCTYPE html><html><head><title>Student Learning Portal</title><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><script src="/socket.io/socket.io.js"></script><style>:root{--accent:#00ffcc;--glow:rgba(0,255,204,0.2);--glow-strong:rgba(0,255,204,0.4)}body{background-color:#050505;background-image:radial-gradient(circle at center,transparent 0%,#000 90%),linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:100% 100%,40px 40px,40px 40px;background-attachment:fixed;color:#fff;font-family:'Segoe UI',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;overflow:hidden}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#111}::-webkit-scrollbar-thumb{background:#333;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--accent)}#menu-container{position:absolute;z-index:100;background:rgba(0,0,0,0.95);width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter:blur(5px)}.screen{display:none;flex-direction:column;align-items:center;width:100%;max-width:950px}.active{display:flex}h1{font-size:60px;margin-bottom:30px;letter-spacing:4px;text-align:center;font-weight:900;text-transform:uppercase}h1 span{background:linear-gradient(135deg,var(--accent),#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 30px var(--glow);animation:titlePulse 3s infinite ease-in-out}@keyframes titlePulse{0%,100%{filter:drop-shadow(0 0 10px var(--glow))}50%{filter:drop-shadow(0 0 25px var(--accent))}}.tech-panel{background:rgba(10,10,10,0.8);border:1px solid var(--accent);box-shadow:0 0 20px var(--glow);border-radius:8px;padding:30px;display:flex;flex-direction:column;align-items:center;backdrop-filter:blur(10px)}.input-std{background:#111;border:1px solid #333;color:#fff;padding:12px;font-size:18px;border-radius:4px;margin:10px 0;width:300px;text-align:center;transition:0.3s}.input-std:focus{border-color:var(--accent);box-shadow:0 0 10px var(--glow);outline:none;background:#000}.btn{padding:15px 40px;font-size:16px;cursor:pointer;border:none;font-weight:800;border-radius:4px;margin:8px;width:300px;text-transform:uppercase;transition:all 0.2s ease-in-out;box-shadow:0 4px 15px rgba(0,0,0,0.5);letter-spacing:1px;position:relative;overflow:hidden}.btn:hover{transform:translateY(-2px) scale(1.02);filter:brightness(1.2);letter-spacing:3px;box-shadow:0 0 20px var(--glow)}.btn-green{background:#00ffcc;color:#000}.btn-zen{background:#a29bfe;color:#000}.btn-apm{background:#ff5555;color:#fff}.btn-ffa{background:#ff9900;color:#000}.btn-blue{background:#00a8ff;color:#fff}#main-split{display:flex;flex-direction:row;gap:40px;align-items:stretch;margin-top:10px}.menu-left{width:340px}.user-info{margin-bottom:20px;font-size:16px;color:#ccc;text-align:center;width:100%;line-height:1.6;border-bottom:1px solid #333;padding-bottom:15px}.user-info span{color:#fff;font-weight:bold;font-size:18px}.menu-right{width:340px;justify-content:flex-start}.lb-header-text{color:var(--accent);font-size:14px;font-weight:bold;text-align:center;margin-bottom:10px;margin-top:20px;text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid #333;padding-bottom:5px;width:100%}.lb-header-text:first-child{margin-top:0}.lb-list{width:100%;font-family:'Segoe UI',sans-serif;font-size:13px;color:#fff}.lb-item{display:flex;justify-content:space-between;padding:8px 5px;border-bottom:1px solid #1a1a1a;transition:background 0.2s}.lb-item:hover{background:rgba(255,255,255,0.05)}.rank-num{color:#ffcc00;font-weight:bold;margin-right:5px}#stats-layout{display:flex;width:900px;height:550px;gap:20px}#stats-list{width:250px;background:#050505;border:1px solid var(--accent);box-shadow:0 0 15px var(--glow);border-radius:4px;overflow-y:auto;padding:10px}#stats-detail{flex:1;background:#050505;border:1px solid var(--accent);box-shadow:0 0 15px var(--glow);border-radius:4px;padding:20px;display:flex;flex-direction:column;overflow:hidden}.player-item{padding:12px;cursor:pointer;border-bottom:1px solid #222;color:#888;font-weight:bold;transition:0.2s}.player-item:hover{background:#111;color:#fff;padding-left:15px}.player-item.selected{background:var(--glow);color:var(--accent);border-color:var(--accent)}.stat-user-title{font-size:32px;color:var(--accent);font-weight:900;margin-bottom:20px;text-transform:uppercase;letter-spacing:2px;text-shadow:0 0 10px var(--glow)}.stat-section-label{font-size:12px;color:#666;margin-bottom:8px;letter-spacing:1px;font-weight:bold;border-bottom:1px solid #333;padding-bottom:4px;width:100%;display:block}.stat-row{display:flex;gap:15px;margin-bottom:20px;width:100%}.stat-card{flex:1;background:#111;border:1px solid #333;border-radius:4px;padding:10px;text-align:center;transition:0.2s}.stat-card:hover{border-color:var(--accent);box-shadow:0 0 5px var(--glow);transform:translateY(-2px)}.stat-card-label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px}.stat-card-val{font-size:20px;color:#fff;font-weight:900;font-family:monospace}.stat-card-val.highlight{color:#ffcc00}.history-wrapper{flex:1;overflow-y:auto;border:1px solid #222;background:#0a0a0a;border-radius:4px}.history-table{width:100%;border-collapse:collapse;font-size:12px;font-family:monospace}.history-table th{background:#111;color:var(--accent);padding:10px;text-align:center;position:sticky;top:0;border-bottom:1px solid #333;z-index:2}.history-table td{padding:8px;border-bottom:1px solid #222;text-align:center;color:#ccc}.history-table tr:hover td{background:#151515;color:#fff}.game-area{display:flex;flex-direction:row;justify-content:center;align-items:flex-start;gap:40px;transform:scale(0.9);transition:0.5s}@media(max-height:950px){.game-area{transform:scale(0.75)}}@media only screen and (max-width:1200px){.game-area{transform:scale(0.65);transform-origin:top center;margin-top:0}}.stats-header{display:flex;gap:15px;margin-bottom:10px}.stat-box-top{background:#000;border:1px solid var(--accent);box-shadow:0 0 5px var(--glow);width:100px;padding:8px 0;text-align:center;transition:border-color 0.3s,box-shadow 0.3s}.stat-label{font-size:11px;color:var(--accent);font-weight:bold;letter-spacing:1px;margin-bottom:4px;text-transform:uppercase;transition:color 0.3s}.stat-val{font-size:18px;font-weight:bold;color:#fff;font-family:monospace}.game-columns{display:flex;align-items:flex-start;gap:15px}.col-left{display:flex;flex-direction:column;gap:15px;width:150px}.box-container{background:#000;border:1px solid var(--accent);box-shadow:0 0 8px var(--glow);display:flex;flex-direction:column;align-items:center;position:relative;width:100%;box-sizing:border-box;padding-bottom:5px;transition:border-color 0.3s,box-shadow 0.3s}.box-header{width:100%;text-align:center;font-size:12px;color:var(--accent);padding-top:5px;padding-bottom:5px;font-weight:bold;transition:color 0.3s}.box-hold{height:100px;justify-content:flex-start}.box-stat-side{height:60px;justify-content:center;padding:0}.col-center{position:relative}.main-board-wrap{border:2px solid var(--accent);background:#000;box-shadow:0 0 20px var(--glow-strong);position:relative;transition:border-color 0.3s,box-shadow 0.3s}.col-right{display:flex;flex-direction:column;width:150px}.box-next{height:400px;justify-content:flex-start}.side-canvas{width:100%;display:block}.garbage-container{width:12px;height:900px;background:#111;border:1px solid #333;position:absolute;left:-20px;overflow:hidden}.garbage-fill{position:absolute;bottom:0;width:100%;background:#ff0033;transition:height 0.2s}#ffa-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px}.mini-card{display:flex;flex-direction:column;align-items:center;background:#000;border:1px solid #333;padding:5px}#home-btn{position:fixed;top:20px;left:20px;z-index:2000;padding:10px 25px;background:#ff0033;color:#fff;border:none;font-weight:900;cursor:pointer;box-shadow:0 0 10px rgba(255,0,51,0.4);font-family:'Segoe UI',sans-serif;letter-spacing:1px}#home-btn:hover{background:#ff3355;transform:scale(1.05)}#chat-container{position:fixed;bottom:0;right:0;width:320px;z-index:200;display:flex;flex-direction:column}#chat-header{background:#222;padding:5px;display:flex;justify-content:flex-end}#chat-close{background:#ff0000;color:white;border:none;cursor:pointer;font-weight:bold;width:24px;height:24px;border-radius:2px;display:flex;align-items:center;justify-content:center}#chat-history{height:200px;background:rgba(0,0,0,0.9);overflow-y:auto;padding:10px;font-family:monospace;font-size:12px}#chat-input{background:#fff;color:#000;border:none;padding:10px;font-family:'Segoe UI',sans-serif;outline:none}.chat-line{margin-bottom:4px;word-wrap:break-word}.chat-user{font-weight:bold;color:var(--accent)}#chat-open-btn{position:fixed;bottom:10px;right:10px;z-index:190;padding:10px 20px;background:#000;color:var(--accent);border:1px solid var(--accent);box-shadow:0 0 5px var(--glow);font-weight:bold;cursor:pointer;font-family:monospace;display:none}#chat-open-btn:hover{background:#111}.float-text{position:absolute;left:50%;transform:translateX(-50%);font-weight:900;opacity:0;pointer-events:none;transition:0.1s;text-align:center;width:300px;text-shadow:0 4px 8px rgba(0,0,0,0.9);font-style:italic;z-index:50}.action-text{top:250px;font-size:36px;color:#fff;letter-spacing:2px}.combo-text{top:200px;font-size:28px;color:#ffcc00}.b2b-text{top:160px;font-size:18px;color:var(--accent);letter-spacing:2px}.sent-text{top:300px;font-size:50px;color:#ff0055;font-weight:900}.overlay{position:absolute;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:150;display:flex;justify-content:center;align-items:center;flex-direction:column;pointer-events:none}.hidden{display:none !important}#cnt-txt{font-size:120px;font-weight:900;color:#fff}#results-table{border-collapse:collapse;margin-top:20px;font-family:monospace;font-size:20px;width:600px}#results-table th{color:var(--accent);padding:10px;border-bottom:2px solid #fff}#results-table td{padding:10px;border-bottom:1px solid #444;text-align:center;color:#fff}.rank-1{color:#ffcc00 !important;font-weight:bold}#kill-feed{position:absolute;bottom:20px;left:20px;width:300px;display:flex;flex-direction:column;gap:5px;pointer-events:none;z-index:100}.feed-msg{background:rgba(255,0,0,0.2);color:#ff5555;padding:5px;border-left:3px solid #ff5555;font-family:monospace}@keyframes pop{from{transform:scale(1)}to{transform:scale(1.1)}}canvas{display:block}</style></head><body><button id="home-btn" class="hidden" onclick="goHome()">HOME</button><div id="menu-container"><div id="scr-login" class="screen active" style="width:auto;"><h1>PROJECT <span>A</span></h1><p style="color:#888;margin-bottom:10px;">STUDENT LOGIN</p><input type="text" id="username" class="input-std" placeholder="USERNAME" maxlength="12" oninput="saveCreds()"><input type="password" id="password" class="input-std" placeholder="PASSWORD" oninput="saveCreds()"><button class="btn btn-green" onclick="attemptLogin()">LOGIN / REGISTER</button></div><div id="scr-main" class="screen"><h1>PROJECT <span>A</span></h1><div id="main-split"><div class="menu-left tech-panel"><div class="user-info">Welcome, <span id="display-user">Guest</span><br>Your Wins: <span id="display-wins">0</span><br>Best APM: <span id="display-apm">0</span></div><button class="btn btn-zen" onclick="startZen()">ZEN MODE</button><button class="btn btn-apm" onclick="startAPMTest()">APM TEST</button><button class="btn btn-ffa" onclick="joinFFA()">ONLINE FFA</button><button class="btn btn-blue" onclick="openStats()">STATS / HISTORY</button><button class="btn" style="background:#222;color:#888;margin-top:20px;" onclick="logOut()">LOGOUT</button></div><div class="menu-right tech-panel"><div class="lb-header-text">ONLINE WIN LEADERBOARD</div><div id="lb-wins" class="lb-list"><div style="text-align:center;color:#666;">Loading...</div></div><div class="lb-header-text">HIGHEST COMBO</div><div id="lb-combo" class="lb-list"><div style="text-align:center;color:#666;">Loading...</div></div></div></div></div><div id="scr-stats" class="screen"><h2 style="color:var(--accent);margin-bottom:10px;">PLAYER STATISTICS</h2><div id="stats-layout"><div id="stats-list"></div><div id="stats-detail"><div style="text-align:center;color:#666;margin-top:100px;font-size:18px;">Select a player to view details.</div></div></div><button class="btn" onclick="goHome()" style="margin-top:20px;background:#222;color:#fff;border:1px solid #444;">BACK TO MENU</button></div><div id="scr-wait" class="screen"><h2 id="wait-msg">JOINING...</h2><div id="lobby-count" style="color:#888;margin-top:10px;"></div><button class="btn btn-ffa" style="background:#333;color:#fff;" onclick="goHome()">CANCEL</button></div></div><div id="overlay-cnt" class="overlay hidden"><div id="cnt-txt">3</div></div><div id="overlay-results" class="overlay hidden"><h1 style="color:var(--accent);">RESULTS</h1><table id="results-table"><thead><tr><th>#</th><th>PLAYER</th><th>SURVIVED</th><th>APM</th><th>PPS</th><th>SENT</th><th>RECV</th></tr></thead><tbody id="results-body"></tbody></table><div class="sub-txt" style="margin-top:20px;font-size:16px;color:#888;">Next round in <span id="res-timer">5</span>s...</div></div><div id="kill-feed"></div><button id="chat-open-btn" onclick="toggleChat()">CHAT</button><div id="chat-container" class="hidden"><div id="chat-header"><button id="chat-close" onclick="toggleChat()">X</button></div><div id="chat-history"></div><input type="text" id="chat-input" placeholder="Chat here..." onkeydown="sendChat(event)"></div><div id="game-ui" class="game-area hidden"><div id="p1-root" class="player-root"><div class="stats-header"><div class="stat-box-top"><div class="stat-label">TIME</div><div id="s-time" class="stat-val">00:00</div></div><div class="stat-box-top"><div class="stat-label">PPS</div><div id="s-pps" class="stat-val">0.00</div></div><div class="stat-box-top"><div class="stat-label">APM</div><div id="s-apm" class="stat-val">0</div></div></div><div class="game-columns"><div class="col-left"><div class="box-container"><div class="box-header">HOLD</div><canvas id="p1-h" class="side-canvas" width="150" height="160"></canvas></div><div style="flex:1"></div><div class="box-container box-stat-side"><div class="box-header">SENT</div><div id="s-sent" class="stat-val" style="margin-bottom:5px;">0</div></div><div class="box-container box-stat-side"><div class="box-header">RECV</div><div id="s-recv" class="stat-val" style="margin-bottom:5px;">0</div></div></div><div class="col-center"><div class="garbage-container"><div id="p1-g" class="garbage-fill"></div></div><div class="main-board-wrap"><canvas id="p1" width="120" height="900"></canvas><div id="pop-action" class="float-text action-text">QUAD</div><div id="pop-combo" class="float-text combo-text">2 COMBO</div><div id="pop-b2b" class="float-text b2b-text">B2B</div><div id="pop-sent" class="float-text sent-text">+4</div></div></div><div class="col-right"><div class="box-container"><div class="box-header">NEXT</div><canvas id="p1-n" class="side-canvas" width="150" height="400"></canvas></div></div></div></div><div id="ffa-grid"></div></div><script>const COLS=4,ROWS=30,B_SIZE=30,PIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]],COLORS=['#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921'],OFFSETS_JLSTZ=[[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]],[[0,0],[0,0],[0,0],[0,0],[0,0]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]],OFFSETS_I=[[[0,0],[-1,0],[2,0],[-1,0],[2,0]],[[0,-1],[0,-1],[0,-1],[0,1],[0,-2]],[[-1,0],[0,0],[0,0],[0,1],[0,-2]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[-1,1],[2,1],[-1,1],[2,0],[-1,0]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[0,1],[0,1],[0,1],[0,-1],[0,2]],[[0,-1],[0,-1],[0,-1],[0,1],[0,-2]]],KICK_INDEX={"0_1":0,"1_0":1,"1_2":2,"2_1":3,"2_3":4,"3_2":5,"3_0":6,"0_3":7};let socket=null,gameActive=false,inputLocked=false,isSpectator=false,gameMode='zen',startTime=0,apmTimer=null,statsCache={};function setTheme(e){let t=document.documentElement;t.style.setProperty("--accent",e);let n=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);t.style.setProperty("--glow",`rgba(${n}, ${o}, ${a}, 0.2)`),t.style.setProperty("--glow-strong",`rgba(${n}, ${o}, ${a}, 0.4)`)}window.onload=function(){localStorage.getItem("savedUser")&&(document.getElementById("username").value=localStorage.getItem("savedUser"),localStorage.getItem("savedPass")&&(document.getElementById("password").value=localStorage.getItem("savedPass")),attemptLogin())};function saveCreds(){localStorage.setItem("savedUser",document.getElementById("username").value),localStorage.setItem("savedPass",document.getElementById("password").value)}function navTo(e){document.querySelectorAll(".screen").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active")}function logOut(){localStorage.clear(),document.getElementById("chat-container").classList.add("hidden"),location.reload()}function toggleChat(){let e=document.getElementById("chat-container"),t=document.getElementById("chat-open-btn");"none"===e.style.display||e.classList.contains("hidden")?(e.style.display="flex",e.classList.remove("hidden"),t.style.display="none"):(e.style.display="none",t.style.display="block")}function attemptLogin(){let e=document.getElementById("username").value.trim(),t=document.getElementById("password").value.trim();return e&&t?(socket||connect(),void socket.emit("login_attempt",{username:e,password:t})):alert("Please enter Username and Password.")}function goHome(){gameActive=!1,clearTimeout(apmTimer),socket&&socket.emit("leave_lobby"),document.getElementById("game-ui").classList.add("hidden"),document.getElementById("home-btn").classList.add("hidden"),document.getElementById("kill-feed").innerHTML="",document.querySelectorAll(".overlay").forEach(e=>e.classList.add("hidden")),document.getElementById("menu-container").style.display="flex",setTheme("#00ffcc"),navTo("scr-main")}function openStats(){return socket?(socket.emit("request_all_stats"),void navTo("scr-stats")):alert("Please login first.")}function startZen(){socket&&socket.emit("leave_lobby"),gameMode="zen",setTheme("#a29bfe"),setupGameUI(),p1.initRNG(999*Math.random()),p1.reset(),gameActive=!0,loop()}function startAPMTest(){socket&&socket.emit("leave_lobby"),gameMode="apm_test",setTheme("#ff5555"),clearTimeout(apmTimer),setupGameUI(),p1.initRNG(999*Math.random()),p1.reset(),gameActive=!0,loop(),apmTimer=setTimeout(()=>{gameActive=!1;let e=p1.elAPM.innerText,t=document.getElementById("overlay-cnt");t.classList.remove("hidden"),document.getElementById("cnt-txt").innerText=e+" APM",socket&&socket.emit("submit_apm",e),setTimeout(goHome,3e3)},6e4)}function joinFFA(){navTo("scr-wait"),document.getElementById("wait-msg").innerText="JOINING FFA LOBBY...",setTheme("#ff9900"),socket.emit("join_ffa")}function setupGameUI(){document.getElementById("menu-container").style.display="none",document.getElementById("game-ui").classList.remove("hidden"),document.getElementById("home-btn").classList.remove("hidden")}function connect(){if(socket)return;socket=io(),socket.on("login_response",e=>{e.success?(navTo("scr-main"),document.getElementById("display-user").innerText=e.username.toUpperCase(),document.getElementById("display-wins").innerText=e.wins,document.getElementById("display-apm").innerText=e.bestAPM,document.getElementById("chat-container").classList.remove("hidden")):alert(e.msg)}),socket.on("leaderboard_update",e=>{let t=document.getElementById("lb-wins");t.innerHTML="",e.wins.forEach((e,n)=>{t.innerHTML+=`<div class="lb-item"><span class="rank-num">${n+1}.</span> <span>${e.name}</span> <span style="font-weight:bold; color:var(--accent);">${e.val} W</span></div>`});let n=document.getElementById("lb-combo");n.innerHTML="",e.combos&&e.combos.forEach((e,t)=>{n.innerHTML+=`<div class="lb-item"><span class="rank-num">${t+1}.</span> <span>${e.name}</span> <span style="font-weight:bold; color:var(--accent);">${e.val} x</span></div>`})}),socket.on("receive_all_stats",e=>{statsCache=e;let t=document.getElementById("stats-list");t.innerHTML="";Object.keys(e).sort((t,n)=>{let o=e=>{(e=e[e].history||[]).length;return e.length?e.reduce((e,t)=>e+(t.apm||0),0)/e.length:0};return o(n)-o(t)}).forEach(n=>{let o=e[n].history||[],a=o.length?(o.reduce((e,t)=>e+(t.apm||0),0)/o.length).toFixed(0):0,s=document.createElement("div");s.className="player-item",s.innerHTML=`<span>${n}</span> <span style="color:#666">${a} APM</span>`,s.onclick=()=>{document.querySelectorAll(".player-item").forEach(e=>e.classList.remove("selected")),s.classList.add("selected"),showStatDetails(n)},t.appendChild(s)})}),socket.on("start_countdown",e=>{if("zen"===gameMode||"apm_test"===gameMode)return;gameMode="ffa",setTheme("#ff9900"),setupGameUI(),document.getElementById("overlay-results").classList.add("hidden");let t=document.getElementById("overlay-cnt"),n=document.getElementById("cnt-txt");t.classList.remove("hidden");let o=e.duration;n.innerText=o,inputLocked=!0;let a=setInterval(()=>{--o>0?n.innerText=o:(clearInterval(a),t.classList.add("hidden"))},1e3)}),socket.on("match_start",e=>{"zen"!==gameMode&&"apm_test"!==gameMode&&(inputLocked=!1,gameMode=e.mode,isSpectator=!1,setupOnlineGame(e.seed,e.players))}),socket.on("receive_garbage",e=>{"zen"!==gameMode&&"apm_test"!==gameMode&&!isSpectator&&p1.receiveGarbage(e)}),socket.on("enemy_board_update",e=>{"zen"!==gameMode&&"apm_test"!==gameMode&&drawEnemy(e.id,e.grid)}),socket.on("elimination",e=>{feed(`${e.username} eliminated by ${e.killer}!`)}),socket.on("request_win_stats",()=>{socket.emit("match_won",p1.getStats())}),socket.on("match_summary",e=>{if("zen"===gameMode||"apm_test"===gameMode)return;gameActive=!1;let t=document.getElementById("overlay-results"),n=document.getElementById("results-body");n.innerHTML="",e.forEach(e=>{n.innerHTML+=`<tr><td class="${1===e.place?"rank-1":""}">${e.place}</td><td>${e.username}</td><td>${e.durationStr}</td><td>${e.apm}</td><td>${e.pps}</td><td>${e.sent}</td><td>${e.recv}</td></tr>`}),t.classList.remove("hidden");let o=5,a=document.getElementById("res-timer");a.innerText=o;let s=setInterval(()=>{o--,a.innerText=o,o<=0&&clearInterval(s)},1e3)}),socket.on("lobby_reset",()=>{if("zen"===gameMode||"apm_test"===gameMode)return;document.getElementById("overlay-results").classList.add("hidden"),"ffa"===gameMode&&goHome()}),socket.on("receive_chat",e=>{let t=document.getElementById("chat-history");t.innerHTML+=`<div class="chat-line"><span class="chat-user">${e.user}:</span> ${e.text}</div>`,t.scrollTop=t.scrollHeight}),socket.on("update_my_wins",e=>document.getElementById("display-wins").innerText=e),socket.on("update_my_apm",e=>document.getElementById("display-apm").innerText=e),socket.on("ffa_spectate",e=>{"zen"!==gameMode&&"apm_test"!==gameMode&&(document.getElementById("wait-msg").innerText="SPECTATING...",setTimeout(()=>{isSpectator=!0,gameMode="ffa",setupGameUI(),setupOnlineGame(e.seed,e.players)},1e3))})}function showStatDetails(e){let t=statsCache[e],n=document.getElementById("stats-detail"),o=0,a=0,s=0,r=0,i=t.history.length;i>0&&(o=(t.history.reduce((e,t)=>e+(t.apm||0),0)/i).toFixed(1),a=(t.history.reduce((e,t)=>e+parseFloat(t.pps||0),0)/i).toFixed(2),s=(t.history.reduce((e,t)=>e+(t.sent||0),0)/i).toFixed(1),r=(t.history.reduce((e,t)=>e+(t.received||0),0)/i).toFixed(1));let c=`<div class="stat-user-title">${e}</div>`;c+='<span class="stat-section-label">CAREER HIGHS</span>',c+=`<div class="stat-row"><div class="stat-card"><div class="stat-card-label">WINS</div><div class="stat-card-val highlight">${t.wins}</div></div><div class="stat-card"><div class="stat-card-label">MAX COMBO</div><div class="stat-card-val highlight">${t.bestCombo||0}</div></div><div class="stat-card"><div class="stat-card-label">BEST APM</div><div class="stat-card-val highlight">${t.bestAPM||0}</div></div></div>`,c+='<span class="stat-section-label">AVERAGE PERFORMANCE</span>',c+=`<div class="stat-row"><div class="stat-card"><div class="stat-card-label">AVG APM</div><div class="stat-card-val">${o}</div></div><div class="stat-card"><div class="stat-card-label">AVG PPS</div><div class="stat-card-val">${a}</div></div><div class="stat-card"><div class="stat-card-label">AVG SENT</div><div class="stat-card-val">${s}</div></div><div class="stat-card"><div class="stat-card-label">AVG RECV</div><div class="stat-card-val">${r}</div></div></div>`,c+=`<span class="stat-section-label">RECENT MATCHES (${i})</span>`,c+='<div class="history-wrapper"><table class="history-table"><thead><tr><th>DATE</th><th>PLACE</th><th>APM</th><th>PPS</th><th>SENT</th><th>COMBO</th></tr></thead><tbody>',[...t.history].reverse().forEach(e=>{let t=new Date(e.date).toLocaleDateString(),n=1===e.place?"#ffcc00":2===e.place?"#c0c0c0":3===e.place?"#cd7f32":"#fff";c+=`<tr><td>${t}</td><td style="color:${n}; font-weight:bold;">#${e.place}</td><td>${e.apm}</td><td>${e.pps}</td><td>${e.sent}</td><td>${e.maxCombo||0}</td></tr>`}),c+="</tbody></table></div>",n.innerHTML=c}function setupOnlineGame(e,t){gameActive=!0,p1.initRNG(e),p1.reset();let n=document.getElementById("ffa-grid");n.innerHTML="",t.forEach(e=>{if(e.id!==socket.id){let t=document.createElement("div");t.className="mini-card",t.innerHTML=`<div style="font-size:10px; color:#888">${e.username}</div><canvas id="cvs_${e.id}" width="80" height="520"></canvas>`,n.appendChild(t)}}),document.getElementById("p1-root").style.opacity=isSpectator?"0.3":"1",loop()}function drawEnemy(e,t){let n=document.getElementById(`cvs_${e}`);if(!n)return;let o=n.getContext("2d");o.fillStyle="#000",o.fillRect(0,0,80,520),t&&t.forEach((e,t)=>e.forEach((e,n)=>{e&&(o.fillStyle=e,o.fillRect(20*n,20*t,19,19))}))}function feed(e){let t=document.getElementById("kill-feed"),n=document.createElement("div");n.className="feed-msg",n.innerText=e,t.appendChild(n),setTimeout(()=>n.remove(),4e3)}function sendChat(e){if("Enter"===e.key){let e=document.getElementById("chat-input"),t=e.value.trim();t&&socket&&(socket.emit("send_chat",t),e.value="")}}class SeededRNG{constructor(e){this.s=e}next(){return(this.s=(9301*this.s+49297)%233280)/233280}}class Player{constructor(){this.ctx=document.getElementById("p1").getContext("2d"),this.nCtx=document.getElementById("p1-n").getContext("2d"),this.hCtx=document.getElementById("p1-h").getContext("2d"),this.gBar=document.getElementById("p1-g"),this.elSent=document.getElementById("s-sent"),this.elRecv=document.getElementById("s-recv"),this.elTime=document.getElementById("s-time"),this.elPPS=document.getElementById("s-pps"),this.elAPM=document.getElementById("s-apm"),this.popAct=document.getElementById("pop-action"),this.popCmbo=document.getElementById("pop-combo"),this.popB2B=document.getElementById("pop-b2b"),this.popSent=document.getElementById("pop-sent"),this.rotation=0,this.grid=Array.from({length:30},()=>Array(4).fill(0)),this.bag=[],this.queue=[],this.holdId=null,this.canHold=!0,this.pendingG=0,this.combo=-1,this.maxCombo=0,this.b2b=0,this.dropCounter=0,this.lockTimer=0,this.dasTimer=0,this.arrTimer=0,this.piecesPlaced=0,this.linesSentTotal=0,this.linesRecvTotal=0,this.rng=new SeededRNG(1),this.startTime=Date.now()}getStats(){let e=(Date.now()-this.startTime)/1e3;return{apm:e>0?Math.floor(this.linesSentTotal/e*60):0,pps:e>0?(this.piecesPlaced/e).toFixed(2):"0.00",sent:this.linesSentTotal,recv:this.linesRecvTotal,maxCombo:this.maxCombo}}initRNG(e){this.rng=new SeededRNG(e)}reset(){this.grid.forEach(e=>e.fill(0)),this.bag=[],this.queue=[],this.piecesPlaced=0,this.linesSentTotal=0,this.linesRecvTotal=0,this.pendingG=0,this.startTime=Date.now(),this.holdId=null,this.canHold=!0,this.maxCombo=0,this.rotation=0,this.drawSide(this.hCtx,[this.holdId]);for(let e=0;e<4;e++)this.queue.push(this.pull());this.spawn()}pull(){if(!this.bag.length){this.bag=[0,1,2,3,4,5,6];for(let e=6;e>0;e--){let t=Math.floor(this.rng.next()*(e+1));[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}return this.bag.pop()}spawn(e=this.queue.shift()){this.queue.push(this.pull()),this.rotation=0,this.active={pos:{x:0,y:-1},matrix:PIECES[e],id:e,color:COLORS[e]},this.lastMoveRotate=!1,this.lockTimer=0,this.collide(),this.drawSide(this.nCtx,this.queue),this.sendBoard()}collide(e=this.active.matrix,t=this.active.pos){for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)if(e[n][o]){let e=o+t.x,a=n+t.y;if(e<0||e>=4||a>=30||a>=0&&this.grid[a][e])return!0}return!1}rotate(e=1){let t=this.rotation,n=(t+e+4)%4,o=this.active.matrix[0].map((e,t)=>this.active.matrix.map(e=>e[t]).reverse()),a=0===this.active.id;if(1===this.active.id)return;let s=a?OFFSETS_I:OFFSETS_JLSTZ,r=KICK_INDEX[`${t}_${n}`],i=s[r],c={x:this.active.pos.x,y:this.active.pos.y};for(let e=0;e<i.length;e++){let t=i[e];if(this.active.pos.x=c.x+t[0],this.active.pos.y=c.y-t[1],!this.collide(o,this.active.pos))return void this.applyRotation(o,n)}for(let e of[[-1,0],[1,0],[-2,0],[2,0],[-3,0]])if(this.active.pos.x=c.x+e[0],this.active.pos.y=c.y+e[1],!this.collide(o,this.active.pos))return void this.applyRotation(o,n);this.active.pos.x=c.x,this.active.pos.y=c.y}applyRotation(e,t){this.active.matrix=e,this.rotation=t,this.lastMoveRotate=!0,this.isGrounded()&&(this.lockTimer=0),this.sendBoard()}move(e){this.active.pos.x+=e,this.collide()?(this.active.pos.x-=e):(this.lastMoveRotate=!1,this.isGrounded()&&(this.lockTimer=0),this.sendBoard())}isGrounded(){this.active.pos.y++;let e=this.collide();return this.active.pos.y--,e}hardDrop(){for(;!this.collide();)this.active.pos.y++;this.active.pos.y--,this.lock()}hold(e=1){let t=this.active.id;if(1===e){if(!this.canHold)return;null===this.holdId?(this.holdId=t,this.spawn()):(id=this.holdId,this.holdId=t,this.spawn(id)),this.canHold=!1}this.drawSide(this.hCtx,[this.holdId])}lock(){let e=!0;if(this.active.matrix.forEach((t,n)=>t.forEach((t,o)=>{if(t){let t=n+this.active.pos.y;t>=0&&(this.grid[t][o+this.active.pos.x]=this.active.color,t>=4&&(e=!1))}})),this.piecesPlaced++,this.sweep(),e&&0===this.sweep())return"zen"!==gameMode&&"apm_test"!==gameMode&&socket?(socket.emit("player_died",this.getStats()),isSpectator=!0,void(document.getElementById("p1-root").style.opacity="0.3")):void this.reset();this.canHold=!0,this.spawn()}sweep(){let e=0,t=!0;for(let n=29;n>=0;n--)this.grid[n].every(e=>0!==e)?(this.grid.splice(n,1),this.grid.unshift(Array(4).fill(0)),e++,n++):this.grid[n].some(e=>0!==e)&&(t=!1);if(e>0){this.combo++,this.combo>this.maxCombo&&(this.maxCombo=this.combo);let n=0,o="";o=1==e?"SINGLE":2==e?"DOUBLE":3==e?"TRIPLE":"QUAD",n=4==e?4:e-1,t&&(o="ALL CLEAR",n+=10),this.showText(this.popAct,o),4==e?(this.b2b++,this.b2b>1&&(n+=1,this.showText(this.popB2B,"B2B x"+(this.b2b-1)))):this.b2b=0,this.combo>0&&(n+=Math.floor((this.combo-1)/2),this.showText(this.popCmbo,this.combo+" COMBO")),n>0&&this.showText(this.popSent,"+"+n),this.pendingG>0&&(amt=Math.min(this.pendingG,n),this.pendingG-=amt,n-=amt),this.linesSentTotal+=n,n>0&&"ffa"===gameMode&&socket&&!isSpectator&&socket.emit("send_garbage",{mode:gameMode,amount:n})}else for(this.combo=-1;this.pendingG>0;){this.pendingG--;let e=Array(4).fill("#555");e[Math.floor(4*Math.random())]=0,this.grid.shift(),this.grid.push(e)}return this.gBar.style.height=30*this.pendingG+"px",this.updateStats(),e}receiveGarbage(e){this.pendingG=Math.min(this.pendingG+e,10),this.linesRecvTotal+=e,this.gBar.style.height=30*this.pendingG+"px",this.updateStats()}updateStats(){let e=(Date.now()-this.startTime)/1e3;this.elSent.innerText=this.linesSentTotal,this.elRecv.innerText=this.linesRecvTotal,this.elPPS.innerText=e>0?(this.piecesPlaced/e).toFixed(2):"0.00",this.elAPM.innerText=e>0?Math.floor(this.linesSentTotal/e*60):0;let t=e;"apm_test"===gameMode&&(t=60-e)<0&&(t=0);let n=Math.floor(t/60).toString().padStart(2,"0"),o=Math.floor(t%60).toString().padStart(2,"0");this.elTime.innerText=`${n}:${o}`}drawSide(e,t){e.fillStyle="#000",e.fillRect(0,0,e.canvas.width,e.canvas.height),t.forEach((t,n)=>{if(null!==t){e.fillStyle=COLORS[t];let o=PIECES[t],a=20*o[0].length,s=20*o.length,r=(e.canvas.width-a)/2,i=80*n+(80-s)/2;o.forEach((t,n)=>{t.forEach((t,o)=>{t&&e.fillRect(r+20*o,i+20*n,19,19)})})}})}sendBoard(){if(socket&&!isSpectator){let e=JSON.parse(JSON.stringify(this.grid));this.active.matrix.forEach((t,n)=>t.forEach((t,o)=>{t&&e[n+this.active.pos.y]&&(e[n+this.active.pos.y][o+this.active.pos.x]=this.active.color)})),socket.emit("update_board",e)}}showText(e,t){e.innerText=t,e.style.opacity=1,setTimeout(()=>e.style.opacity=0,1e3)}update(e){let t=700;"ffa"===gameMode&&(t=Math.max(100,700-70*Math.floor((Date.now()-this.startTime)/1e3/30))),this.dropCounter+=e,this.dropCounter>t&&(this.active.pos.y++,this.collide()?this.active.pos.y--:(this.lockTimer=0,this.lastMoveRotate=!1),this.dropCounter=0),this.isGrounded()&&(this.lockTimer+=e,this.lockTimer>500&&this.lock()),this.sendBoard()}draw(){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,120,900),this.ctx.fillStyle="rgba(255, 0, 0, 0.2)",this.ctx.fillRect(0,0,120,120),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.lineWidth=1,this.ctx.beginPath();for(let e=1;e<4;e++)this.ctx.moveTo(30*e,120),this.ctx.lineTo(30*e,900);for(let e=4;e<30;e++)this.ctx.moveTo(0,30*e),this.ctx.lineTo(120,30*e);this.ctx.stroke(),this.grid.forEach((e,t)=>e.forEach((e,n)=>{e&&(this.ctx.fillStyle=e,this.ctx.fillRect(30*n,30*t,29,29))})),this.active&&!isSpectator&&(x={...this.active.pos},y=x,function(){for(;!p1.collide(p1.active.matrix,y);)y.y++;y.y--}(),this.ctx.fillStyle="rgba(255,255,255,0.15)",this.active.matrix.forEach((e,t)=>e.forEach((e,n)=>{e&&this.ctx.fillRect(30*(y.x+n),30*(y.y+t),29,29)})),this.ctx.fillStyle=this.active.color,this.active.matrix.forEach((e,t)=>e.forEach((e,n)=>{e&&this.ctx.fillRect(30*(this.active.pos.x+n),30*(this.active.pos.y+t),29,29)})))}}const p1=new Player,keys=new Set,ctrl={left:"ArrowLeft",right:"ArrowRight",rotate:"ArrowUp",soft:"ArrowDown",hard:"Space",hold:"ShiftLeft"};window.addEventListener("keydown",e=>{if(("zen"===gameMode||"apm_test"===gameMode)&&"INPUT"!==document.activeElement.tagName&&"KeyR"===e.code)return"zen"===gameMode?startZen():"apm_test"===gameMode&&startAPMTest();!inputLocked&&gameActive&&!isSpectator&&(e.preventDefault(),keys.has(e.code)||(keys.add(e.code),e.code==ctrl.rotate&&p1.rotate(),e.code==ctrl.hold&&p1.hold(1),e.code==ctrl.hard&&p1.hardDrop(),(e.code==ctrl.left||e.code==ctrl.right)&&(p1.dasTimer=0,p1.arrTimer=0,p1.move(e.code==ctrl.left?-1:1))))}),window.addEventListener("keyup",e=>keys.delete(e.code));let lastT=0;function loop(e=0){let t=e-lastT;lastT=e,gameActive&&(!isSpectator&&!inputLocked&&(keys.has(ctrl.soft)&&(p1.active.pos.y++,p1.collide()?p1.active.pos.y--:(p1.lastMoveRotate=!1,p1.lockTimer=0)),(keys.has(ctrl.left)||keys.has(ctrl.right))&&(d=keys.has(ctrl.left)?-1:1,p1.dasTimer+=t,p1.dasTimer>130&&(p1.arrTimer+=t,p1.arrTimer>0&&(p1.move(d),p1.arrTimer=0))),p1.update(t),p1.updateStats()),p1.draw()),requestAnimationFrame(loop)}</script></body></html>
