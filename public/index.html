<!DOCTYPE html>
<html>
<head>
    <title>Project Asmondy</title>
    <style>
        body { background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* --- MENU --- */
        #menu-container { position: absolute; z-index: 100; background: rgba(0,0,0,0.98); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 600px; }
        .active { display: flex; }
        
        h1 { font-size: 50px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(0,255,204,0.3); }
        .btn { padding: 15px 40px; font-size: 18px; cursor: pointer; border: none; font-weight: bold; border-radius: 6px; margin: 8px; width: 260px; text-transform: uppercase; transition: 0.2s; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn-green { background: #00ffcc; color: #000; }
        .btn-blue { background: #00a8ff; color: #fff; }
        .btn-red { background: #ff0055; color: #fff; }
        .input-std { background: #222; border: 1px solid #444; color: #fff; padding: 12px; font-size: 18px; border-radius: 5px; margin: 10px 0; width: 300px; text-align: center; }

        /* BROWSER */
        #room-list { width: 100%; height: 300px; overflow-y: auto; background: #111; border: 1px solid #333; margin: 10px 0; padding: 5px; }
        .room-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; }
        .room-item:hover { background: #222; }

        /* LOBBY */
        #lobby-players { width: 100%; background: #111; padding: 10px; margin-bottom: 20px; }
        .p-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #333; }
        .crown { color: #ffcc00; font-weight: bold; margin-left: 5px; }

        /* --- GAME UI --- */
        #home-btn { position: absolute; top: 15px; left: 15px; z-index: 200; padding: 8px 15px; background: #ff0055; color: #fff; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; box-shadow: 0 0 10px rgba(255,0,85,0.5); }
        #home-btn:hover { transform: scale(1.1); }

        .overlay { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 150; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; }
        .hidden { display: none !important; }
        
        #cnt-txt { font-size: 150px; font-weight: 900; color: #fff; text-shadow: 0 0 50px #fff; animation: pop 0.5s infinite alternate; }
        #win-txt { font-size: 80px; font-weight: 900; color: #00ffcc; text-shadow: 0 0 30px #00ffcc; }
        .sub-txt { font-size: 24px; color: #fff; margin-top: 10px; font-weight: normal; }

        /* GRID */
        .game-area { display: flex; gap: 40px; transform: scale(0.9); transition: 0.5s; width: 100%; justify-content: center; }
        .player-container { display: flex; align-items: flex-end; gap: 10px; position: relative; }
        .main-board-wrap { position: relative; border: 4px solid #333; background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .garbage-bar { width: 12px; height: 780px; background: #111; border: 1px solid #333; position: relative; overflow: hidden; }
        .garbage-fill { position: absolute; bottom: 0; width: 100%; background: #ff0033; transition: height 0.2s; }
        .side-col { display: flex; flex-direction: column; height: 780px; justify-content: space-between; }
        .side-box { border: 2px solid #333; background: #000; display: flex; flex-direction: column; align-items: center; padding-top: 10px; margin-bottom: 10px; color:#888; font-size:12px; }
        .stat-value { font-size: 14px; font-weight: bold; color: #fff; font-family: monospace; }
        canvas { display: block; }

        #ffa-grid { display: flex; gap: 15px; justify-content: center; opacity: 0; transition: opacity 0.5s; }
        .mini-card { background: #111; padding: 5px; border: 1px solid #333; text-align: center; }

        @keyframes pop { from { transform: scale(1); } to { transform: scale(1.1); } }
        #kill-feed { position: absolute; bottom: 20px; left: 20px; width: 300px; display: flex; flex-direction: column; gap: 5px; pointer-events: none; z-index: 100; }
        .feed-msg { background: rgba(255,0,0,0.2); color: #ff5555; padding: 5px; border-left: 3px solid #ff5555; font-family: monospace; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <button id="home-btn" class="hidden" onclick="goHome()">HOME</button>

    <div id="menu-container">
        <div id="scr-main" class="screen active">
            <h1>PROJECT <span style="color:#00ffcc">ASMONDY</span></h1>
            <input type="text" id="username" class="input-std" placeholder="ENTER USERNAME" maxlength="12">
            <button class="btn btn-green" onclick="startLocal()">LOCAL PLAY</button>
            <button class="btn btn-zen" onclick="startZen()">ZEN MODE</button>
            <button class="btn btn-blue" onclick="navTo('scr-custom')">CUSTOM LOBBIES</button>
        </div>

        <div id="scr-custom" class="screen">
            <h2>CUSTOM LOBBIES</h2>
            <button class="btn btn-blue" onclick="refreshRooms(); navTo('scr-browse')">BROWSE LOBBIES</button>
            <button class="btn btn-green" onclick="navTo('scr-create')">CREATE LOBBY</button>
            <button class="btn btn-red" onclick="navTo('scr-main')">BACK</button>
        </div>

        <div id="scr-browse" class="screen">
            <h2>BROWSE</h2>
            <div id="room-list">Loading...</div>
            <div style="display:flex; gap:10px">
                <input type="text" id="join-pass" class="input-std" placeholder="Password (Optional)" style="width:200px">
                <button class="btn btn-blue" onclick="refreshRooms()" style="width:100px; margin:10px 0;">REFRESH</button>
            </div>
            <button class="btn btn-red" onclick="navTo('scr-custom')">BACK</button>
        </div>

        <div id="scr-create" class="screen">
            <h2>CREATE ROOM</h2>
            <input type="text" id="c-name" class="input-std" placeholder="Room Name">
            <input type="text" id="c-pass" class="input-std" placeholder="Password (Optional)">
            <select id="c-mode" class="input-std">
                <option value="duel">DUEL (1v1)</option>
                <option value="ffa">FFA (Split Trash)</option>
            </select>
            <button class="btn btn-green" onclick="createRoom()">CREATE</button>
            <button class="btn btn-red" onclick="navTo('scr-custom')">BACK</button>
        </div>

        <div id="scr-lobby" class="screen">
            <h2 id="lobby-title">LOBBY</h2>
            <div id="lobby-players"></div>
            <p id="lobby-wait">Waiting for host...</p>
            <button id="btn-start" class="btn btn-green hidden" onclick="requestStart()">START MATCH</button>
            <button class="btn btn-red" onclick="goHome()">LEAVE</button>
        </div>
    </div>

    <div id="overlay-cnt" class="overlay hidden"><div id="cnt-txt">3</div></div>
    <div id="overlay-win" class="overlay hidden">
        <div id="win-txt">WINNER</div>
        <div class="sub-txt">NEXT ROUND IN 3s...</div>
    </div>

    <div id="kill-feed"></div>
    <div id="game-ui" class="game-area hidden">
        <div id="p1-root" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
            <div class="player-container">
                <div class="garbage-bar"><div id="p1-g" class="garbage-fill"></div></div>
                <div class="side-col">
                    <div class="side-box" style="height:80px">HOLD<canvas id="p1-h" width="60" height="50"></canvas></div>
                    <div class="side-box">SENT<div id="p1-sent" class="stat-value">0</div></div>
                </div>
                <div class="main-board-wrap">
                    <div style="position:absolute; top:-25px; width:100%; text-align:center; color:#00e5ff; font-weight:bold;">YOU</div>
                    <canvas id="p1" width="120" height="780"></canvas>
                </div>
                <div class="side-col"><div class="side-box" style="height:200px">NEXT<canvas id="p1-n" width="60" height="180"></canvas></div></div>
            </div>
        </div>
        <div id="ffa-grid"></div>
    </div>

    <script>
        // --- CONSTANTS ---
        const COLS = 4, ROWS = 26, B_SIZE = 30;
        const PIECES = [[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]]];
        const COLORS = ['#31C7EF','#F7D308','#FF69B4','#EF2029','#42B642','#9D00FF','#EF7921'];

        let socket = null;
        let gameActive = false, inputLocked = false;
        let isSpectator = false;
        let myUsername = "Player";
        
        // --- NAVIGATION ---
        function navTo(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function goHome() { location.reload(); }
        function getUser() { return document.getElementById('username').value.trim() || "Player"; }

        // --- LOCAL / ZEN ---
        function startLocal() {
            // Placeholder for local duel logic (Keeping file size manageable, focusing on Online features requested)
            alert("Local Duel starting...");
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('home-btn').classList.remove('hidden');
            // (You can paste previous local logic here if needed)
        }
        function startZen() {
            document.getElementById('menu-container').style.display = 'none';
            document.getElementById('home-btn').classList.remove('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            p1.initRNG(Math.random()*999); p1.reset(); 
            gameActive = true; loop();
        }

        // --- ONLINE LOGIC ---
        function connect() {
            if (socket) return;
            socket = io();
            
            socket.on('room_list', showRooms);
            socket.on('err', msg => alert(msg));
            
            socket.on('joined_room', data => {
                navTo('scr-lobby');
                document.getElementById('lobby-title').innerText = `${data.mode.toUpperCase()}: ${data.name}`;
            });

            socket.on('lobby_update', data => {
                const list = document.getElementById('lobby-players');
                list.innerHTML = '';
                data.players.forEach(p => {
                    // Win Indicator: Crown icon with score
                    const wins = p.score > 0 ? ` <span class="crown">ðŸ‘‘${p.score}</span>` : '';
                    list.innerHTML += `<div class="p-item"><span>${p.username}</span><span>${wins}</span></div>`;
                });
                
                if(data.isHost && data.players.length >= 2) {
                    document.getElementById('btn-start').classList.remove('hidden');
                    document.getElementById('lobby-wait').classList.add('hidden');
                } else {
                    document.getElementById('btn-start').classList.add('hidden');
                    document.getElementById('lobby-wait').classList.remove('hidden');
                }
            });

            socket.on('start_countdown', data => {
                document.getElementById('menu-container').style.display = 'none';
                document.getElementById('game-ui').classList.remove('hidden');
                document.getElementById('home-btn').classList.remove('hidden');
                document.getElementById('overlay-win').classList.add('hidden'); // clear win screen
                
                const ov = document.getElementById('overlay-cnt');
                const tx = document.getElementById('cnt-txt');
                ov.classList.remove('hidden');
                
                let n = data.duration;
                tx.innerText = n;
                inputLocked = true;
                
                const iv = setInterval(() => {
                    n--;
                    if(n>0) tx.innerText = n;
                    else { clearInterval(iv); ov.classList.add('hidden'); }
                }, 1000);
            });

            socket.on('match_start', data => {
                inputLocked = false;
                setupMatch(data.seed, data.players);
            });

            socket.on('receive_garbage', n => { if(!isSpectator) p1.receiveGarbage(n); });
            socket.on('enemy_board_update', d => drawEnemy(d.id, d.grid));
            socket.on('elimination', d => feed(`${d.username} eliminated!`));
            
            socket.on('round_over', data => {
                gameActive = false;
                document.getElementById('win-txt').innerText = `${data.winner} WINS!`;
                document.getElementById('overlay-win').classList.remove('hidden');
            });

            socket.on('reset_to_lobby', () => {
                alert("Not enough players. Returning to lobby.");
                document.getElementById('menu-container').style.display = 'flex';
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('home-btn').classList.add('hidden');
                document.getElementById('overlay-win').classList.add('hidden');
                navTo('scr-lobby');
            });
        }

        // --- ROOM ACTIONS ---
        function refreshRooms() { connect(); socket.emit('get_rooms'); }
        function showRooms(list) {
            const el = document.getElementById('room-list');
            el.innerHTML = '';
            if(list.length===0) el.innerHTML = '<div style="color:#666">No lobbies found.</div>';
            list.forEach(r => {
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `<span>${r.name}</span><span>${r.mode} | ${r.count}P | ${r.state}</span>`;
                div.onclick = () => {
                    const pass = document.getElementById('join-pass').value;
                    socket.emit('join_room', { id: r.id, pass, username: getUser() });
                };
                el.appendChild(div);
            });
        }
        function createRoom() {
            connect();
            socket.emit('create_room', {
                name: document.getElementById('c-name').value || (getUser()+"'s Room"),
                pass: document.getElementById('c-pass').value,
                mode: document.getElementById('c-mode').value,
                username: getUser()
            });
        }
        function requestStart() { socket.emit('request_start'); }

        // --- GAME ENGINE ---
        function setupMatch(seed, players) {
            gameActive = true;
            isSpectator = false;
            p1.initRNG(seed); p1.reset();
            
            const grid = document.getElementById('ffa-grid');
            grid.innerHTML = '';
            // If > 3 players, hide enemies initially
            grid.style.opacity = (players.length > 3) ? '0' : '1';
            
            players.forEach(p => {
                if(p.id !== socket.id) {
                    const d = document.createElement('div');
                    d.className = 'mini-card';
                    d.innerHTML = `<div style="font-size:10px; color:#888">${p.username}</div><canvas id="c_${p.id}" width="80" height="520"></canvas>`;
                    grid.appendChild(d);
                }
            });
            loop();
        }

        function drawEnemy(id, grid) {
            const cvs = document.getElementById(`c_${id}`);
            if(!cvs) return;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle='#000'; ctx.fillRect(0,0,80,520);
            if(grid) grid.forEach((r,y)=>r.forEach((v,x)=>{ if(v){ ctx.fillStyle=v; ctx.fillRect(x*20,y*20,19,19); } }));
        }

        function feed(msg) {
            const f = document.getElementById('kill-feed');
            const d = document.createElement('div');
            d.className='feed-msg'; d.innerText=msg;
            f.appendChild(d); setTimeout(()=>d.remove(),4000);
            // Check visibility
            if(socket) {
                // Simplified visibility check: if few players, show grid
                const grid = document.getElementById('ffa-grid');
                if(grid.style.opacity === '0') grid.style.opacity = '1'; 
            }
        }

        // --- PLAYER LOGIC ---
        class SeededRNG { constructor(s){this.s=s;} next(){this.s=(this.s*9301+49297)%233280;return this.s/233280;} }
        class Player {
            constructor(){
                this.ctx=document.getElementById('p1').getContext('2d');
                this.nCtx=document.getElementById('p1-n').getContext('2d');
                this.hCtx=document.getElementById('p1-h').getContext('2d');
                this.gBar=document.getElementById('p1-g');
                this.sentDiv=document.getElementById('p1-sent');
                this.grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
                this.bag=[]; this.queue=[]; this.holdId=null; this.canHold=true;
                this.pendingG=0; this.sent=0; this.active=null; this.rng=new SeededRNG(1);
            }
            initRNG(s){this.rng=new SeededRNG(s);}
            reset(){ this.grid.forEach(r=>r.fill(0)); this.bag=[]; this.queue=[]; this.pendingG=0; this.sent=0; for(let i=0;i<4;i++)this.queue.push(this.pull()); this.spawn(); }
            pull(){ if(!this.bag.length){this.bag=[0,1,2,3,4,5,6]; for(let i=6;i>0;i--){const j=Math.floor(this.rng.next()*(i+1));[this.bag[i],this.bag[j]]=[this.bag[j],this.bag[i]];}} return this.bag.pop(); }
            spawn(id=this.queue.shift()){
                this.queue.push(this.pull());
                this.active={pos:{x:0,y:0},matrix:PIECES[id],id:id,color:COLORS[id]};
                if(this.collide()){
                    if(socket) { 
                        socket.emit('player_died'); 
                        isSpectator=true; 
                        document.getElementById('p1-root').style.opacity='0.3';
                        document.getElementById('ffa-grid').style.opacity='1';
                    } else {
                        // Local/Zen Reset
                        this.reset();
                    }
                }
                this.drawSide(this.nCtx,this.queue); this.sendBoard();
            }
            sendBoard(){ if(socket && !isSpectator){ const d=JSON.parse(JSON.stringify(this.grid)); this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v&&d[y+this.active.pos.y])d[y+this.active.pos.y][x+this.active.pos.x]=this.active.color;})); socket.emit('update_board',d); } }
            collide(m=this.active.matrix,p=this.active.pos){ for(let y=0;y<m.length;y++)for(let x=0;x<m[y].length;x++)if(m[y][x]&&(this.grid[y+p.y]===undefined||this.grid[y+p.y][x+p.x]===undefined||this.grid[y+p.y][x+p.x]))return true; return false; }
            rotate(){ const r=this.active.matrix[0].map((_,i)=>this.active.matrix.map(row=>row[i]).reverse()); const k=[0,-1,1,-2]; for(let i of k)if(!this.collide(r,{x:this.active.pos.x+i,y:this.active.pos.y})){this.active.pos.x+=i;this.active.matrix=r;this.sendBoard();return;} }
            move(d){ this.active.pos.x+=d; if(this.collide())this.active.pos.x-=d; else this.sendBoard(); }
            hardDrop(){ while(!this.collide())this.active.pos.y++; this.active.pos.y--; this.lock(); }
            hold(){ if(!this.canHold)return; const c=this.active.id; if(this.holdId===null){this.holdId=c;this.spawn();}else{const t=this.holdId;this.holdId=c;this.spawn(t);} this.canHold=false; this.drawSide(this.hCtx,[this.holdId]); }
            lock(){
                this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v)this.grid[y+this.active.pos.y][x+this.active.pos.x]=this.active.color;}));
                this.sweep(); this.canHold=true; this.spawn();
            }
            sweep(){
                let l=0; for(let y=ROWS-1;y>=0;y--)if(this.grid[y].every(v=>v!==0)){this.grid.splice(y,1);this.grid.unshift(Array(COLS).fill(0));l++;y++;}
                if(l>0){
                    let atk=(l==4)?4:(l-1);
                    if(this.pendingG>0){let c=Math.min(this.pendingG,atk); this.pendingG-=c; atk-=c;}
                    if(atk>0){ this.sent+=atk; this.sentDiv.innerText=this.sent; if(socket && !isSpectator) socket.emit('send_garbage',{amount:atk}); }
                } else {
                    while(this.pendingG>0){this.pendingG--; const r=Array(COLS).fill('#555'); r[Math.floor(Math.random()*COLS)]=0; this.grid.shift(); this.grid.push(r);}
                }
                this.gBar.style.height=(this.pendingG*30)+'px';
            }
            receiveGarbage(n){ this.pendingG+=n; this.gBar.style.height=(this.pendingG*30)+'px'; }
            drawSide(ctx,ids){ ctx.fillStyle='#000'; ctx.fillRect(0,0,60,180); ids.forEach((id,i)=>{if(id!==null){ctx.fillStyle=COLORS[id]; PIECES[id].forEach((r,y)=>r.forEach((v,x)=>{if(v)ctx.fillRect(x*12+8,y*12+i*50+10,11,11);}));}}); }
            draw(){
                this.ctx.fillStyle='#000'; this.ctx.fillRect(0,0,120,780);
                this.grid.forEach((r,y)=>r.forEach((v,x)=>{if(v){this.ctx.fillStyle=v; this.ctx.fillRect(x*B_SIZE,y*B_SIZE,B_SIZE-1,B_SIZE-1);}}));
                if(this.active && !isSpectator){
                    let g={...this.active.pos}; while(!this.collide(this.active.matrix,g))g.y++; g.y--;
                    this.ctx.fillStyle='rgba(255,255,255,0.15)'; this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v)this.ctx.fillRect((g.x+x)*B_SIZE,(g.y+y)*B_SIZE,B_SIZE-1,B_SIZE-1);}));
                    this.ctx.fillStyle=this.active.color; this.active.matrix.forEach((r,y)=>r.forEach((v,x)=>{if(v)this.ctx.fillRect((this.active.pos.x+x)*B_SIZE,(this.active.pos.y+y)*B_SIZE,B_SIZE-1,B_SIZE-1);}));
                }
            }
        }

        const p1 = new Player();
        const keys = new Set();
        const ctrl = {left:'ArrowLeft',right:'ArrowRight',rotate:'ArrowUp',soft:'ArrowDown',hard:'Space',hold:'ShiftLeft'};
        
        window.addEventListener('keydown', e=>{
            if(!inputLocked && gameActive && !isSpectator){
                if(["Space","ArrowUp","ArrowDown"].includes(e.code)) e.preventDefault();
                if(!keys.has(e.code)){
                    keys.add(e.code);
                    if(e.code==ctrl.rotate)p1.rotate();
                    if(e.code==ctrl.hold)p1.hold();
                    if(e.code==ctrl.hard)p1.hardDrop();
                    if(e.code==ctrl.left || e.code==ctrl.right){ p1.dasTimer=0; p1.arrTimer=0; p1.move(e.code==ctrl.left?-1:1); }
                }
            }
        });
        window.addEventListener('keyup', e=>keys.delete(e.code));

        let lastT=0;
        function loop(t=0){
            const dt=t-lastT; lastT=t;
            if(gameActive && !isSpectator && !inputLocked){
                if(keys.has(ctrl.soft)){ p1.active.pos.y++; if(p1.collide())p1.active.pos.y--; }
                if(keys.has(ctrl.left)||keys.has(ctrl.right)){
                    const d=keys.has(ctrl.left)?-1:1;
                    p1.dasTimer+=dt;
                    if(p1.dasTimer>130){ p1.arrTimer+=dt; if(p1.arrTimer>0){ p1.move(d); p1.arrTimer=0; } }
                }
                p1.dropCounter+=dt; 
                if(p1.dropCounter>700){ p1.active.pos.y++; if(p1.collide()){p1.active.pos.y--; p1.lock();} p1.dropCounter=0; p1.sendBoard(); }
                p1.draw();
            }
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>